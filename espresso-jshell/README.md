# GraalVM Demos: Native jshell and Espresso

This demo showcases the integration between [GraalVM Native Image](https://www.graalvm.org/reference-manual/native-image/) and [Java-on-Truffle (Espresso)](https://www.graalvm.org/reference-manual/java-on-truffle/).
You will build a native executable of `jshell`, that executes dynamically generated bytecode on Espresso.
This hybrid mode achieves instant startup, beating the vanilla `jshell` in both: time to the first interaction and time to evaluate a simple expression.

JShell is a Java read-eval-print loop tool first introduced in the JDK 9, but this demo also shows how to run `jshell` on Java 8.

## Prerequisites

- GraalVM for Java 11 or higher
- Native Image support
- Java-on-Truffle (Espresso) support

You can download the latest GraalVM [here](https://www.graalvm.org/downloads/).
Having [installed GraalVM](https://www.graalvm.org/docs/getting-started/#install-graalvm), you can add Native Image and Java on Truffle (Espresso) support easily.
GraalVM comes with `gu` which is a command line utility to install and manage additional functionalities, and to install Native Image and Espresso, run this single command:

```bash
<graalvm>/bin/gu install native-image espresso
```

## How to Build
You should set the `GRAALVM_HOME` variable to the GraalVM home:
```bash
export GRAALVM_HOME="/path/to/graalvm"
```

Then exetute the `build-espresso-jshell.sh` script:
```bash
./build-espresso-jshell.sh
```

It generates a native executable: `espresso-jshell` in the working directory.
This native executable, `espresso-jshell [options...]`, by default runs on Java 11 with instant startup.

Launch `espresso-jshell`, execute some Java code and see the output immediately.
To exit the shell, type `/exit`.

## Running jshell for Java 8

```bash
export GRAALVM_HOME="/path/to/graalvm"
export JDK8_HOME="/path/to/jdk8"
sh jshell8.sh [options...]
```

You can run the following snippets to convince yourself that it runs on the Java 8 mode:
```java
System.getProperty("java.vm.version");

// `jshell -C-source -C8` forbids getModule() access from code,
// but it is still accessible through reflection.
Object.class.getModule();

// In true Java 8 mode, getModule() is not accessible at all,
// not even through reflection.
Class.class.getDeclaredMethod("getModule");
```

Pass system properties to `espresso` with `-R-Dkey=value`.
Pass polyglot options to `espresso` with `-Rjava.InlineFieldAccessors -Rengine.Compilation=false`.

## Details
`espresso-jshell` behaves similar to `jshell -execution local` and should not be directly compared with the default `jshell` execution engine, e.g., class redefinition is not supported (`jshell -execution local` does not support it either).
It does not  support execution engines other than `-execution espresso`.
It is not fully standalone, it needs the _jars/jmods_ to compile and for Espresso to run.
